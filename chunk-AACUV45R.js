import{c as Z}from"./chunk-4PHGQJCB.js";import{a as z,b as N,c as U,d as H}from"./chunk-2PF4VZYY.js";import{k as G}from"./chunk-FNTTNCNS.js";import{h as V,k as W,l as $,m as q}from"./chunk-2TMWR2NM.js";import{m as D}from"./chunk-2UE2V2R5.js";import{c as B}from"./chunk-XRGWM46W.js";import{b as j}from"./chunk-EBVX5MXQ.js";import{c as A}from"./chunk-KKFSZARV.js";import{Ab as w,Bb as m,Cb as c,Db as k,Mb as v,Sa as a,Yb as p,_b as F,ac as E,db as y,hb as R,ra as T,ua as x,ub as S,vb as I,wb as P,yb as L,zb as O}from"./chunk-JNWBK6C6.js";import{i as b,j as M,k as _}from"./chunk-GV7GV3NK.js";function J(h,e){if(h&1&&(m(0,"mat-form-field",5),k(1,"input",6),c()),h&2){let r=v();p("embedded",r.embedded==="embedded"),a(),w("value",r.spellerValue())}}function K(h,e){if(h&1&&(m(0,"div",7,0),F(2),c()),h&2){let r=e.$implicit,t=e.$index,i=v();p("embedded",i.embedded==="embedded")("highlightRow",i.getRow(t)===i.highlightedRow)("highlightCol",i.getCol(t)===i.highlightedCol)("highlightTargetRow",i.getRow(t)===i.highlightedTargetRow)("highlightTargetCol",i.getCol(t)===i.highlightedTargetCol),a(2),E(" ",r.value," ")}}var l=class l extends U{showIcon=T(Object.fromEntries(this.cues().map(e=>[e.class,!1])));fullWindowLink="/paradigms/p300/speller/stimuli";normalWindowLink="/paradigms/p300/speller";startCountdownValue=5;cols=6;highlightedRow=-1;highlightedCol=-1;highlightedTargetRow=-1;highlightedTargetCol=-1;spellerValue=T("");ngOnInit(){return _(this,null,function*(){M(l.prototype,this,"ngOnInit").call(this),yield this.hardwareService.writeLine("CMD=@CLA;"),yield this.hardwareService.writeLine('CMD=@TITLE TEXT="P300 Speller" COLOR=BLUE SIZE=3;'),this.generateCues()})}generateCues(){this.cues.set(Object.keys(this.stimulusCommandMap).filter(e=>e.length===1).map(e=>({class:e,value:e,keys:this.stimulusCommandMap[e]})).sort((e,r)=>{let t=g=>/^[A-Za-z]/.test(g),i=t(e.value),n=t(r.value);return i&&!n?-1:!i&&n?1:e.value.localeCompare(r.value)}))}generateTrials(){let e=[];for(let r=0;r<this.experimentConfig.target_characters;r++){let t=this.generateShuffledList(6),i=this.generateShuffledList(6),n=i[0]*this.cols+t[0],g=t[0],f=i[0];t=t.slice(1),i=i.slice(1),e.push({class:this.cues()[n]?.class+"-Feedback",duration:this.experimentConfig.target_duration,soa:this.experimentConfig.soa_inter_trial});let o=[],d=["c","r"],u=Math.floor(this.experimentConfig.target_probability*this.experimentConfig.repetitions_per_target/100);for(let s=0;s<u;s++)o.push({class:d[o.length%2]+this.cues()[n]?.class+"-Target",duration:this.experimentConfig.flash_duration,soa:this.experimentConfig.soa_inter_trial});for(let s=o.length;s<this.experimentConfig.repetitions_per_target;s++){let C=i[s%5]*this.cols+t[s%5];o.push({class:d[o.length%2]+this.cues()[C]?.class+"-NonTarget",duration:this.experimentConfig.flash_duration,soa:this.experimentConfig.soa_inter_trial})}o=this.shufflePreservingParity(o),o[o.length-1].soa=this.experimentConfig.soa_intra_trial,e.push(...o)}return e.flat()}showTrial(e){if(e===null){this.highlightedTargetRow=-1,this.highlightedTargetCol=-1,this.highlightedRow=-1,this.highlightedCol=-1;return}e.length===1&&(e=e+"-Feedback");let[r,t]=e.split("-"),i=this.cues().findIndex(n=>n.class===r[r.length-1]);if(e.endsWith("Feedback")&&this.stimuliMode()==="neurofeedback"){this.spellerValue.set(this.spellerValue()+(this.cues()[i]?.value??""));return}this.propagateClassMarker(t.trim()),r.startsWith("c")?(this.highlightedRow=-1,this.highlightedCol=this.getCol(i)):r.startsWith("r")?(this.highlightedRow=this.getRow(i),this.highlightedCol=-1):(this.highlightedTargetRow=this.getRow(i),this.highlightedTargetCol=this.getCol(i))}stopStimuliSequence(){this.showTrial(null)}getRow(e){return Math.floor(e/this.cols)}getCol(e){return e%this.cols}runStimuliSequence(){if(this.stimuliMode()==="sequential")return super.runStimuliSequence();this.spellerValue.set("");let e=this.experimentConfig.flash_duration,r=this.experimentConfig.soa_inter_trial,t=[],i=()=>{t.forEach(o=>window.clearTimeout(o)),t=[]},n=o=>{this.showTrial(o.class),this.onTrial(o)},g=o=>{this.showTrial(null)},f=o=>{let d=this.cues().at(Math.floor(Math.random()*this.cues().length))?.class??"",u={class:`${o}${d}-NonTarget`,duration:e,soa:r},s=window.setTimeout(()=>{n(u);let C=window.setTimeout(()=>{g(u),f(o==="c"?"r":"c")},e);t.push(C)},r);t.push(s)};return f("c"),i}static \u0275fac=(()=>{let e;return function(t){return(e||(e=x(l)))(t||l)}})();static \u0275cmp=y({type:l,selectors:[["app-stimuli"]],features:[R],decls:5,vars:4,consts:[["cueElement",""],[3,"hostRef"],[1,"grid-list","grid-responsive-6"],[1,"input-line",3,"embedded"],[1,"cue","conditional-visible",3,"embedded","highlightRow","highlightCol","highlightTargetRow","highlightTargetCol"],[1,"input-line"],["matInput","","placeholder","","readonly","true",3,"value"],[1,"cue","conditional-visible"]],template:function(r,t){r&1&&(m(0,"app-stimuli-layout",1)(1,"div",2),S(2,J,2,3,"mat-form-field",3),L(3,K,3,11,"div",4,P),c()()),r&2&&(w("hostRef",t),a(),p("embedded",t.embedded==="embedded"),a(),I(t.stimuliMode()==="neurofeedback"?2:-1),a(),O(t.cues()))},dependencies:[B,z,j,Z,G,H,A,q,$,V,W,D],styles:[".cue[_ngcontent-%COMP%]{color:var(--mat-sys-primary);font-size:5vh;opacity:.3;width:100%;height:100%;display:flex;align-items:center;justify-content:center}.cue.embedded[_ngcontent-%COMP%]{font-size:3vh}.highlightRow[_ngcontent-%COMP%], .highlightCol[_ngcontent-%COMP%]{color:var(--mat-sys-on-primary);opacity:1;background-color:var(--mat-sys-on-surface-variant)}.highlightTargetRow.highlightTargetCol[_ngcontent-%COMP%]{color:red;opacity:1;transform:scale(1.5)}.grid-list[_ngcontent-%COMP%]{position:unset;height:80vh;width:80vh;margin:auto;gap:0}.grid-list.embedded[_ngcontent-%COMP%]{height:60%;width:100%;margin-top:10%}.input-line[_ngcontent-%COMP%]{width:80vh;margin-top:64px;position:absolute;top:16px}.input-line.embedded[_ngcontent-%COMP%]{width:80%;margin-left:10%;margin-top:0}"]})};b([N("TRIAL",{arguments:["CLASS"],example:"Trial Target",description:"Highlights the specified class by activating its visual icon while deactivating all others. Useful for indicating the target class during a trial or cue presentation."})],l.prototype,"showTrial",1);var X=l;export{X as a};
