import{Y as l,aa as v,ra as h,ua as p}from"./chunk-FHWKK7EC.js";import{i}from"./chunk-5KHZBZE7.js";var f=class r{consoleOutput;attach(e){this.consoleOutput=e.nativeElement}addConsoleLine(e){if(!this.consoleOutput||e.startsWith("#"))return;let n=new Date().toLocaleTimeString("en-US",{hour12:!1}),a=document.createElement("div");a.textContent=`[${n}] ${e}`,this.consoleOutput.insertBefore(a,this.consoleOutput.firstChild)}static \u0275fac=function(t){return new(t||r)};static \u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"})};var m=class r{constructor(e){this.consoleService=e}isConnected=h(!1);hasAvailableDevice=h(!1);measuringLatency=h(!1);latencyStats=h({latency:0,jitter:0,min:0,max:0,median:0,samples:0});reading=!1;stoped_after_reading=!1;lineQueue=[];waitingResolvers=[];MAX_QUEUE_SIZE=100;sleep=e=>new Promise(t=>setTimeout(t,e));requestAndConnectDevice(){return i(this,null,function*(){yield this.requestDevice(),yield this.connect()})}flushQueues(){this.lineQueue=[],this.waitingResolvers=[]}processLine(e){this.waitingResolvers.length>0?this.waitingResolvers.shift()(e):(this.lineQueue.length>=this.MAX_QUEUE_SIZE&&this.lineQueue.shift(),this.lineQueue.push(e))}measureLatency(){return i(this,null,function*(){this.measuringLatency.set(!0);let e="#";this.latencyStats.set({latency:0,jitter:0,min:0,max:0,median:0,samples:0}),yield this.writeLine('CMD=@BIP;CMD=@TITLE "Latency Test";'),yield this.writeLine("CMD=@LATENCY;"),yield this.sleep(300),yield this.stopListening();for(let s=0;s<10;s++)yield this.writeLine("#DUMMY");let t=[];for(let s=0;s<300;s++){let d=performance.now();yield this.writeLineToSource(e);let w=yield this.readLineFromSource(),y=performance.now()-d;w===e&&t.push(y),yield this.sleep(3)}yield this.writeLineToSource("EXIT");let n=t.reduce((s,d)=>s+d,0)/t.length,a=t.reduce((s,d)=>s+Math.pow(d-n,2),0)/t.length,c=Math.sqrt(a),o=[...t].sort((s,d)=>s-d),u=o.length;this.latencyStats.set({latency:n,jitter:c,min:Math.min(...t),max:Math.max(...t),median:o.length%2===0?(o[u/2-1]+o[u/2])/2:o[Math.floor(u/2)],samples:t.length}),this.measuringLatency.set(!1),yield this.writeLine("CMD=@BIP;CMD=@BRAND;"),yield this.startListening()})}startListening(){return i(this,null,function*(){this.flushQueues(),this.reading=!0,this.stoped_after_reading=!1;let e="";for(;this.reading;)try{let[t,n]=yield this.readChunk();n&&(this.stoped_after_reading=!0),e+=t;let a=e.split(`
`);e=a.pop()||"";for(let c of a)this.consoleService.addConsoleLine(c),this.processLine(c.trim())}catch(t){console.error("Error reading from USB:",t),this.reading=!1,this.stoped_after_reading=!0}})}readLine(){return this.lineQueue.length>0?Promise.resolve(this.lineQueue.shift()):this.waitingResolvers.length>=this.MAX_QUEUE_SIZE?Promise.reject(new Error("Too many pending readLine requests.")):new Promise(e=>{this.waitingResolvers.push(e)})}stopListening(){return i(this,null,function*(){this.reading=!1,this.flushQueues()})}onDisconnect(){setTimeout(()=>this.autoConnect(),1e3)}static \u0275fac=function(t){return new(t||r)(v(f))};static \u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"})};var g=class r extends m{encoder=new TextEncoder;decoder=new TextDecoder;device;interfaceNumber=0;endpointOut=0;endpointIn=0;configurationValue=1;requestDevice(){return i(this,null,function*(){try{this.device=yield navigator.usb.requestDevice({filters:[{vendorId:12346}]})}catch(e){console.error("USB device request failed:",e)}yield this.checkAvailableDevice()})}checkAvailableDevice(){return i(this,null,function*(){let e=yield navigator.usb.getDevices();this.hasAvailableDevice.set(e.length>0)})}connect(){return i(this,null,function*(){if(!this.device)return;this.device.opened||(yield this.device.open()),this.device.configuration===null&&(yield this.device.selectConfiguration(this.configurationValue));let e=this.findCDCInterfaceAndEndpoints();if(!e)throw new Error("No suitable CDC or vendor interface found");this.interfaceNumber=e.interfaceNumber,this.endpointIn=e.endpointIn,this.endpointOut=e.endpointOut,yield this.device.claimInterface(this.interfaceNumber),this.isConnected.set(!0),yield this.startListening(),yield this.writeLine("CMD=@BRAND;")})}autoConnect(){return i(this,null,function*(){let e=yield navigator.usb.getDevices();return e.length===0?!1:(this.device=e[0],yield this.connect(),!0)})}disconnect(){return i(this,null,function*(){if(this.device){yield this.writeLine("CMD=@CLA;");try{this.device.opened&&(yield this.device.releaseInterface(this.interfaceNumber),yield this.device.close())}catch(e){console.warn("Error during disconnect:",e)}finally{this.device=void 0,this.isConnected.set(!1)}yield this.checkAvailableDevice()}})}writeLine(e){return i(this,null,function*(){if(!this.device)return;let t=e.replace(/;/g,`;
`),n=this.encoder.encode(t.endsWith(`
`)?t:t+`
`);yield this.device.transferOut(this.endpointOut,n),this.consoleService.addConsoleLine(e)})}writeLineToSource(e){return i(this,null,function*(){if(!this.device)return;let t=this.encoder.encode(e+`
`);yield this.device.transferOut(this.endpointOut,t)})}readLineFromSource(){return i(this,null,function*(){if(!this.device)return"";let e=yield this.device.transferIn(this.endpointIn,64);return new TextDecoder().decode(e.data?.buffer||new ArrayBuffer(0)).split(`
`)[0]?.trim()||""})}getProperties(){return this.device?[{name:"productName",value:this.device.productName},{name:"productId",value:"0x"+this.device.productId.toString(16).padStart(4,"0")},{name:"vendorId",value:"0x"+this.device.vendorId.toString(16).padStart(4,"0")},{name:"manufacturerName",value:this.device.manufacturerName},{name:"serialNumber",value:this.device.serialNumber},{name:"interfaceNumber",value:this.interfaceNumber},{name:"endpointIn",value:this.endpointIn},{name:"endpointOut",value:this.endpointOut}]:[]}readChunk(){return i(this,null,function*(){if(!this.device)return["",!1];let e=yield this.device.transferIn(this.endpointIn,64);return[this.decoder.decode(e.data?.buffer||new ArrayBuffer(0)),!1]})}findCDCInterfaceAndEndpoints(){if(!this.device?.configuration?.interfaces)return null;for(let e of this.device.configuration.interfaces)for(let t of e.alternates){let{interfaceClass:n,endpoints:a}=t;if(n===10||n===255){let c=a.find(u=>u.direction==="in")?.endpointNumber,o=a.find(u=>u.direction==="out")?.endpointNumber;if(c!==void 0&&o!==void 0)return{interfaceNumber:e.interfaceNumber,endpointIn:c,endpointOut:o}}}return null}static \u0275fac=(()=>{let e;return function(n){return(e||(e=p(r)))(n||r)}})();static \u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"})};export{f as a,m as b,g as c};
