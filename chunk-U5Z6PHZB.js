import{Y as h,aa as v,ra as l}from"./chunk-FHWKK7EC.js";import{i as n}from"./chunk-5KHZBZE7.js";var f=class c{consoleOutput;attach(e){this.consoleOutput=e.nativeElement}addConsoleLine(e){if(!this.consoleOutput)return;let i=new Date().toLocaleTimeString("en-US",{hour12:!1}),r=document.createElement("div");r.textContent=`[${i}] ${e}`,this.consoleOutput.insertBefore(r,this.consoleOutput.firstChild)}static \u0275fac=function(t){return new(t||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};var m=class c{constructor(e){this.consoleService=e}isConnected=l(!1);hasAvailableDevice=l(!1);measuringLatency=l(!1);latencyStats=l({latency:0,jitter:0,min:0,max:0,median:0,samples:0});reading=!1;lineQueue=[];waitingResolvers=[];MAX_QUEUE_SIZE=100;encoder=new TextEncoder;decoder=new TextDecoder;device;interfaceNumber=0;endpointOut=0;endpointIn=0;configurationValue=1;sleep=e=>new Promise(t=>setTimeout(t,e));requestAndConnectDevice(){return n(this,null,function*(){yield this.requestDevice(),yield this.connect()})}requestDevice(){return n(this,null,function*(){try{this.device=yield navigator.usb.requestDevice({filters:[{vendorId:12346}]})}catch(e){console.error("USB device request failed:",e)}yield this.checkAvailableDevice()})}checkAvailableDevice(){return n(this,null,function*(){let e=yield navigator.usb.getDevices();this.hasAvailableDevice.set(e.length>0)})}autoConnect(){return n(this,null,function*(){let e=yield navigator.usb.getDevices();if(e.length===0)return!1;this.device=e[0],this.device.opened||(yield this.device.open()),this.device.configuration===null&&(yield this.device.selectConfiguration(this.configurationValue));let t=this.findCDCInterfaceAndEndpoints();if(!t)throw new Error("No suitable CDC or vendor interface found");return this.interfaceNumber=t.interfaceNumber,this.endpointIn=t.endpointIn,this.endpointOut=t.endpointOut,yield this.device.claimInterface(this.interfaceNumber),this.isConnected.set(!0),yield this.startListening(),!0})}connect(){return n(this,null,function*(){if(!this.device)return;this.device.opened||(yield this.device.open()),this.device.configuration===null&&(yield this.device.selectConfiguration(this.configurationValue));let e=this.device.configuration;if(!e)throw new Error("No configuration found");for(let t of e.interfaces)for(let i of t.alternates){let r=i.endpoints.find(s=>s.direction==="in"),a=i.endpoints.find(s=>s.direction==="out");if((i.interfaceClass===10||i.interfaceClass===255)&&r&&a){this.interfaceNumber=t.interfaceNumber,this.endpointIn=r.endpointNumber,this.endpointOut=a.endpointNumber,yield this.device.claimInterface(this.interfaceNumber),this.isConnected.set(!0),yield this.startListening(),yield this.writeLine("CMD=@BRAND;");return}}throw new Error("No suitable CDC or vendor interface found")})}findCDCInterfaceAndEndpoints(){if(!this.device?.configuration?.interfaces)return null;for(let e of this.device.configuration.interfaces)for(let t of e.alternates){let{interfaceClass:i,endpoints:r}=t;if(i===10||i===255){let a=r.find(u=>u.direction==="in")?.endpointNumber,s=r.find(u=>u.direction==="out")?.endpointNumber;if(a!==void 0&&s!==void 0)return{interfaceNumber:e.interfaceNumber,endpointIn:a,endpointOut:s}}}return null}getProperties(){return this.device?[{name:"productName",value:this.device.productName},{name:"productId",value:"0x"+this.device.productId.toString(16).padStart(4,"0")},{name:"vendorId",value:"0x"+this.device.vendorId.toString(16).padStart(4,"0")},{name:"manufacturerName",value:this.device.manufacturerName},{name:"serialNumber",value:this.device.serialNumber},{name:"interfaceNumber",value:this.interfaceNumber},{name:"endpointIn",value:this.endpointIn},{name:"endpointOut",value:this.endpointOut}]:[]}disconnect(){return n(this,null,function*(){if(this.device){yield this.writeLine("CMD=@CLA;");try{this.device.opened&&(yield this.device.releaseInterface(this.interfaceNumber),yield this.device.close())}catch(e){console.warn("Error during disconnect:",e)}finally{this.device=void 0,this.isConnected.set(!1),this.stopListening()}yield this.checkAvailableDevice()}})}write(e){return n(this,null,function*(){this.device&&(yield this.device.transferOut(this.endpointOut,e))})}read(){return n(this,null,function*(){if(!this.device)return;let e=yield this.device.transferIn(this.endpointIn,64);return new Uint8Array(e.data?.buffer||[])})}writeLine(e){return n(this,null,function*(){if(!this.device)return;let t=e.replace(/;/g,`;
`),i=this.encoder.encode(t.endsWith(`
`)?t:t+`
`);yield this.device.transferOut(this.endpointOut,i),this.consoleService.addConsoleLine(e)})}startListening(){return n(this,null,function*(){if(!this.device){console.warn("No USB device connected.");return}this.flushQueues(),this.reading=!0;let e="";for(;this.reading;)try{let t=yield this.device.transferIn(this.endpointIn,64),i=this.decoder.decode(t.data?.buffer||new ArrayBuffer(0));e+=i;let r=e.split(`
`);e=r.pop()||"";for(let a of r)this.consoleService.addConsoleLine(a),this.processLine(a.trim())}catch(t){console.error("Error reading from USB:",t),this.reading=!1}})}stopListening(){this.reading=!1,this.flushQueues()}readLine(){return this.lineQueue.length>0?Promise.resolve(this.lineQueue.shift()):this.waitingResolvers.length>=this.MAX_QUEUE_SIZE?Promise.reject(new Error("Too many pending readLine requests.")):new Promise(e=>{this.waitingResolvers.push(e)})}readLineFromSource(){return n(this,null,function*(){if(!this.device)return"";let e=yield this.device.transferIn(this.endpointIn,64);return new TextDecoder().decode(e.data?.buffer||new ArrayBuffer(0)).split(`
`)[0]?.trim()||""})}writeLineToSource(e){return n(this,null,function*(){if(!this.device)return;let t=this.encoder.encode(e+`
`);yield this.device.transferOut(this.endpointOut,t)})}processLine(e){this.waitingResolvers.length>0?this.waitingResolvers.shift()(e):(this.lineQueue.length>=this.MAX_QUEUE_SIZE&&this.lineQueue.shift(),this.lineQueue.push(e))}flushQueues(){this.lineQueue=[],this.waitingResolvers=[]}measureLatency(){return n(this,null,function*(){this.measuringLatency.set(!0);let e=".";this.latencyStats.set({latency:0,jitter:0,min:0,max:0,median:0,samples:0}),yield this.writeLine('CMD=@BIP;CMD=@TITLE "Latency Test";'),yield this.writeLine("CMD=@LATENCY;"),yield this.sleep(300),this.stopListening(),yield this.sleep(100);let t=[];for(let o=0;o<300;o++){let d=performance.now();yield this.writeLineToSource(e);let p=yield this.readLineFromSource(),w=performance.now()-d;p===e&&t.push(w),yield this.sleep(3)}yield this.writeLineToSource("EXIT");let i=t.reduce((o,d)=>o+d,0)/t.length,r=t.reduce((o,d)=>o+Math.pow(d-i,2),0)/t.length,a=Math.sqrt(r),s=[...t].sort((o,d)=>o-d),u=s.length;this.latencyStats.set({latency:i,jitter:a,min:Math.min(...t),max:Math.max(...t),median:s.length%2===0?(s[u/2-1]+s[u/2])/2:s[Math.floor(u/2)],samples:t.length}),this.measuringLatency.set(!1),yield this.writeLine("CMD=@BIP;CMD=@BRAND;"),yield this.startListening()})}static \u0275fac=function(t){return new(t||c)(v(f))};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{f as a,m as b};
