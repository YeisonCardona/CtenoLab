import{b as u,c as h}from"./chunk-2CST4VEZ.js";import{b as p}from"./chunk-36YKBAEN.js";import{Y as s,aa as c,ba as o,ra as l,ua as d}from"./chunk-FHWKK7EC.js";import{i as t}from"./chunk-5KHZBZE7.js";var n=class i extends u{mode="serial";samplesToTest=500;delayOnLatencyMeasurement=3;port=null;reader=null;writer=null;readableStreamClosed=null;writableStreamClosed=null;requestDevice(){return t(this,null,function*(){try{this.port=yield navigator.serial.requestPort()}catch(e){console.error("USB device request failed:",e)}yield this.checkAvailableDevice()})}checkAvailableDevice(){return t(this,null,function*(){let e=yield navigator.serial.getPorts();this.hasAvailableDevice.set(e.length>0)})}connect(){return t(this,null,function*(){if(!this.port)return;yield this.port.open({baudRate:115200});let e=new TextDecoderStream;this.readableStreamClosed=this.port.readable?.pipeTo(e.writable)??null,this.reader=e.readable.getReader();let r=new TextEncoderStream;this.writableStreamClosed=r.readable.pipeTo(this.port.writable)??null,this.writer=r.writable.getWriter(),this.readableStreamClosed?.catch(a=>{this.consoleService.addConsoleLine("Device disconnected."),this.isConnected.set(!1),this.stopListening(),this.onDisconnect()}),this.isConnected.set(!0),yield this.startListening(),yield this.writeLine("CMD=@BRAND;")})}autoConnect(){return t(this,null,function*(){let e=yield navigator.serial.getPorts();return e.length===0?!1:(this.port=e[0],yield this.connect(),!0)})}disconnect(){return t(this,null,function*(){try{if(this.reading=!1,this.reader){try{yield this.reader.cancel()}catch(e){console.warn("Reader cancel failed:",e)}this.reader.releaseLock(),this.reader=null}if(this.writer){try{yield this.writer.close()}catch(e){console.warn("Writer close failed:",e)}this.writer.releaseLock(),this.writer=null}this.port&&this.port.readable?.locked===!1&&this.port.writable?.locked===!1&&(yield this.port.close()),this.port=null,this.isConnected.set(!1)}catch(e){console.error("Failed to disconnect:",e)}})}writeLine(e){return t(this,null,function*(){if(!this.writer)return;let r=e.trim().replace(/;\s*/g,`;
`),a=r.endsWith(`
`)?r:r+`
`;yield this.writer.write(a),this.consoleService.addConsoleLine(e)})}writeLineToSource(e){return t(this,null,function*(){this.writer&&(yield this.writer.write(e+`
`))})}readLineFromSource(){return t(this,null,function*(){if(!this.reader)return"";let{value:e,done:r}=yield this.reader.read();return r||e===void 0?"":e.split(`
`)[0]?.trim()||""})}getProperties(){let e=this.port?.getInfo();return e?[{name:"Vendor ID",value:e.usbVendorId?.toString(16).padStart(4,"0")??"Unknown"},{name:"Product ID",value:e.usbProductId?.toString(16).padStart(4,"0")??"Unknown"}]:[]}readChunk(){return t(this,null,function*(){if(!this.reader)return["",!1];let{value:e,done:r}=yield this.reader.read();return[e,r]})}static \u0275fac=(()=>{let e;return function(a){return(e||(e=d(i)))(a||i)}})();static \u0275prov=s({token:i,factory:i.\u0275fac,providedIn:"root"})};var w=class i{constructor(e){this.supabaseService=e;let r=localStorage.getItem("cteno-hardware-connection-mode"),a=r==="usb"||r==="serial"?r:"serial";this.setMode(a)}connectionMode=l("serial");usbService=o(h);serialService=o(n);core=this.usbService;setMode(e){localStorage.setItem("cteno-hardware-connection-mode",e),this.connectionMode.set(e),this.core=e==="usb"?this.usbService:this.serialService}writeLine(e){return t(this,null,function*(){return yield this.core.writeLine(e)})}static \u0275fac=function(r){return new(r||i)(c(p))};static \u0275prov=s({token:i,factory:i.\u0275fac,providedIn:"root"})};export{w as a};
