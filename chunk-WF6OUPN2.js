import{b as d,c as h}from"./chunk-5A7XLOI6.js";import{Y as s,ba as o,ra as c,ua as l}from"./chunk-FHWKK7EC.js";import{i as r}from"./chunk-5KHZBZE7.js";var n=class i extends d{port=null;reader=null;writer=null;readableStreamClosed=null;writableStreamClosed=null;requestDevice(){return r(this,null,function*(){try{this.port=yield navigator.serial.requestPort()}catch(e){console.error("USB device request failed:",e)}yield this.checkAvailableDevice()})}checkAvailableDevice(){return r(this,null,function*(){let e=yield navigator.serial.getPorts();this.hasAvailableDevice.set(e.length>0)})}connect(){return r(this,null,function*(){if(!this.port)return;yield this.port.open({baudRate:115200});let e=new TextDecoderStream;this.readableStreamClosed=this.port.readable?.pipeTo(e.writable)??null,this.reader=e.readable.getReader();let t=new TextEncoderStream;this.writableStreamClosed=t.readable.pipeTo(this.port.writable)??null,this.writer=t.writable.getWriter(),this.readableStreamClosed?.catch(a=>{this.consoleService.addConsoleLine("Device disconnected."),this.isConnected.set(!1),this.stopListening(),this.onDisconnect()}),this.isConnected.set(!0),yield this.startListening(),yield this.writeLine("CMD=@BRAND;")})}autoConnect(){return r(this,null,function*(){let e=yield navigator.serial.getPorts();return e.length===0?!1:(this.port=e[0],yield this.connect(),!0)})}disconnect(){return r(this,null,function*(){try{if(this.reading=!1,this.reader){try{yield this.reader.cancel()}catch(e){console.warn("Reader cancel failed:",e)}this.reader.releaseLock(),this.reader=null}if(this.writer){try{yield this.writer.close()}catch(e){console.warn("Writer close failed:",e)}this.writer.releaseLock(),this.writer=null}this.port&&this.port.readable?.locked===!1&&this.port.writable?.locked===!1&&(yield this.port.close()),this.port=null,this.isConnected.set(!1)}catch(e){console.error("Failed to disconnect:",e)}})}writeLine(e){return r(this,null,function*(){if(!this.writer)return;let t=e.trim().replace(/;\s*/g,`;
`),a=t.endsWith(`
`)?t:t+`
`;yield this.writer.write(a),this.consoleService.addConsoleLine(e)})}writeLineToSource(e){return r(this,null,function*(){this.writer&&(yield this.writer.write(e+`
`))})}readLineFromSource(){return r(this,null,function*(){if(!this.reader)return"";let{value:e,done:t}=yield this.reader.read();return t||e===void 0?"":e.split(`
`)[0]?.trim()||""})}getProperties(){let e=this.port?.getInfo();return e?[{name:"Vendor ID",value:e.usbVendorId?.toString(16).padStart(4,"0")??"Unknown"},{name:"Product ID",value:e.usbProductId?.toString(16).padStart(4,"0")??"Unknown"}]:[]}readChunk(){return r(this,null,function*(){if(!this.reader)return["",!1];let{value:e,done:t}=yield this.reader.read();return[e,t]})}static \u0275fac=(()=>{let e;return function(a){return(e||(e=l(i)))(a||i)}})();static \u0275prov=s({token:i,factory:i.\u0275fac,providedIn:"root"})};var u=class i{connectionMode=c("usb");usbService=o(h);serialService=o(n);core=this.usbService;constructor(){let e=localStorage.getItem("cteno-hardware-connection-mode"),t=e==="usb"||e==="serial"?e:"serial";this.setMode(t)}setMode(e){this.connectionMode.set(e),localStorage.setItem("cteno-hardware-connection-mode",e),this.core=e==="usb"?this.usbService:this.serialService}writeLine(e){return r(this,null,function*(){return yield this.core.writeLine(e)})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=s({token:i,factory:i.\u0275fac,providedIn:"root"})};export{u as a};
