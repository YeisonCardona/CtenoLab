import{a as Y}from"./chunk-ZXYJ7DLS.js";import{c as H}from"./chunk-4PHGQJCB.js";import{a as A,b as $,c as U,d as V}from"./chunk-MVRKTWFJ.js";import{k as G}from"./chunk-FNTTNCNS.js";import{c as q}from"./chunk-XRGWM46W.js";import{b as B}from"./chunk-EBVX5MXQ.js";import{c as N}from"./chunk-KKFSZARV.js";import{Ab as F,Bb as d,Cb as f,Mb as p,Sa as m,Yb as h,Zb as D,_b as P,ac as R,db as k,hb as x,ra as b,tb as y,ua as M,ub as _,vb as E,wb as L,yb as O,zb as I}from"./chunk-JNWBK6C6.js";import{i as w,j as S,k as T}from"./chunk-GV7GV3NK.js";function J(l,e){if(l&1&&P(0),l&2){let i=p().$implicit;R(" ",i.value," Hz ")}}function K(l,e){if(l&1&&(d(0,"div",4,0),_(2,J,1,1),f()),l&2){let i=e.$implicit,t=p();D(t.fixClass(i.class)),h("visible",t.showIcon()[i.class]),y("cue-key",t.fixClass(i.class))("flicker-frequency",i.value),m(2),E(i.value?2:-1)}}var a=class a extends U{showIcon=b(Object.fromEntries(this.cues().map(e=>[e.class,!1])));fullWindowLink="/paradigms/ssvep/direction/stimuli";normalWindowLink="/paradigms/ssvep/direction";startCountdownValue=5;flickers=[];generateCuesOnFormUpdate=!0;ngOnInit(){return T(this,null,function*(){S(a.prototype,this,"ngOnInit").call(this),yield this.hardwareService.writeLine("CMD=@CLA;"),yield this.hardwareService.writeLine('CMD=@TITLE TEXT="SSVEP Direction" COLOR=BLUE SIZE=3;');let e=localStorage.getItem("cteno-hardware-connection-port-fls");yield this.hardwareService.writeLine(`CMD=FLS CH=${e} ACTION=STOP;`)})}generateCues(){let e=["Right","Left","Up","Down"],t=(this.experimentConfig.classes||[]).map((s,u)=>u>=e.length?null:{class:e[u],value:s}).filter(Boolean);this.cues.set(t)}generateTrials(){let e=[],i=this.cues().map(t=>t.class);for(let t of i)for(let s=0;s<this.experimentConfig.trials_per_class;s++)e.push({class:t,duration:this.experimentConfig.stimulus_duration,soa:this.experimentConfig.soa,flicker_duration:this.experimentConfig.flicker_duration});return this.setFlickers(),e=this.shuffle(e),e}setFlickers(){let e=this.experimentConfig.refresh_rate;this.flickers=[],this.cuesDivElement.forEach(i=>{let t=Number(i.nativeElement.getAttribute("flicker-frequency"));this.flickers.push(new Y(i,t,e))})}showTrial(e){this.showIcon.set(Object.fromEntries(this.cues().map(i=>[i.class,i.class===e])))}stopStimuliSequence(){this.showTrial(null),this.flickers.forEach(e=>e.stop())}runStimuliSequence(){if(this.stimuliMode()==="sequential")return this.runStimuliSequenceSecuential();if(this.stimuliMode()==="neurofeedback")return this.runStimuliSequenceNeurofeedback()}runStimuliSequenceNeurofeedback(){this.setFlickers(),this.flickers.forEach(e=>e.start())}runStimuliSequenceSecuential(){let e=this.generateTrials(),i=performance.now(),t=0,s=[],u=r=>{let o=i+e.slice(0,r).reduce((c,n)=>c+n.duration+(n.flicker_duration||0)+n.soa,0);return Math.max(0,o-performance.now())},z=r=>{this.showTrial(r.class),this.hardwareService.writeLine(`CMD=@LOG MESSAGE="Class: ${r.class}" COLOR=GREEN;`)},W=()=>{t++,this.setProgress(100*t/e.length)},Q=r=>{this.flickers.forEach(n=>n.start()),this.propagateClassMarker(r.class);let o=this.cues().find(n=>n.class===r.class)?.value,c=localStorage.getItem("cteno-hardware-connection-port-fls");this.hardwareService.writeLine(`CMD=FLS CH=${c} PWM=255 FREQ=${o} DUTY=5;`)},g=()=>{this.flickers.forEach(o=>o.stop());let r=localStorage.getItem("cteno-hardware-connection-port-fls");this.hardwareService.writeLine(`CMD=FLS CH=${r} ACTION=STOP; `)},v=()=>{s.forEach(r=>window.clearTimeout(r)),s=[],g()},C=()=>{if(t>=e.length){v(),this.onDelivery.set(!1);return}let r=e[t],o=u(t),c=window.setTimeout(()=>{z(r);let n=window.setTimeout(()=>{this.showTrial(null);let X=window.setTimeout(()=>{Q(r);let Z=window.setTimeout(()=>{g(),W(),C()},r.flicker_duration||0);s.push(Z)},300);s.push(X)},r.duration);s.push(n)},o);s.push(c)};return C(),v}static \u0275fac=(()=>{let e;return function(t){return(e||(e=M(a)))(t||a)}})();static \u0275cmp=k({type:a,selectors:[["app-stimuli"]],features:[x],decls:4,vars:3,consts:[["cueElement",""],[3,"hostRef"],[1,"ssvep-direction-container"],[1,"cue","flicker","conditional-visible",3,"class","visible"],[1,"cue","flicker","conditional-visible"]],template:function(i,t){i&1&&(d(0,"app-stimuli-layout",1)(1,"div",2),O(2,K,3,7,"div",3,L),f()()),i&2&&(F("hostRef",t),m(),h("embedded",t.embedded==="embedded"),m(),I(t.cues()))},dependencies:[q,A,B,H,G,V,N],styles:[".ssvep-direction-container[_ngcontent-%COMP%]{position:relative;height:90%;aspect-ratio:1;margin:auto;padding:100px;box-sizing:border-box}.ssvep-direction-container.embedded[_ngcontent-%COMP%]{transform:translateY(5%)}.cue[_ngcontent-%COMP%]{background-color:var(--mat-sys-inverse-on-surface);width:20%;aspect-ratio:1;position:absolute;border-radius:10%;display:flex;align-items:center;justify-content:center;color:color-mix(in srgb,var(--mat-sys-primary) 30%,transparent)}.cue.Up[_ngcontent-%COMP%]{top:0;left:50%;transform:translate(-50%)}.cue.Down[_ngcontent-%COMP%]{bottom:0;left:50%;transform:translate(-50%)}.cue.Left[_ngcontent-%COMP%]{top:50%;left:0;transform:translateY(-50%)}.cue.Right[_ngcontent-%COMP%]{top:50%;right:0;transform:translateY(-50%)}.cue.visible[_ngcontent-%COMP%]{border:10px solid var(--mat-sys-error);box-sizing:border-box}"]})};w([$("TRIAL",{arguments:["CLASS"],example:"Trial Right",description:"Highlights the specified class by activating its visual icon while deactivating all others. Useful for indicating the target class during a trial or cue presentation."})],a.prototype,"showTrial",1);var j=a;export{j as a};
