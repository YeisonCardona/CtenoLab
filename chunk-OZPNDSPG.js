import{c as G}from"./chunk-4PHGQJCB.js";import{a as U,b as y,c as Y,d as j}from"./chunk-PMQPYQZU.js";import{k as V}from"./chunk-FNTTNCNS.js";import{c as z}from"./chunk-XRGWM46W.js";import{b as N}from"./chunk-EBVX5MXQ.js";import{c as B}from"./chunk-KKFSZARV.js";import{Ab as F,Bb as I,Cb as O,Db as P,Mb as A,Sa as g,Yb as v,Zb as q,db as x,fc as H,hb as R,ra as k,tb as L,ua as M,wb as S,yb as _,zb as D}from"./chunk-JNWBK6C6.js";import{i as d,j as T,k as E}from"./chunk-GV7GV3NK.js";var a=class{element;frequencyHz;refreshRateHz;cycleFrames;dutyFrames;animationLoop;isRunning=!1;frameCount=0;constructor(e,i,t,n=.5){this.element=e,this.frequencyHz=i,this.refreshRateHz=t,this.cycleFrames=Math.round(this.refreshRateHz/this.frequencyHz),this.dutyFrames=Math.round(this.cycleFrames*n),this.animationLoop=this.animate.bind(this)}start(){this.isRunning=!0,this.frameCount=0,requestAnimationFrame(this.animationLoop)}stop(){this.isRunning=!1,this.element.nativeElement.style.visibility="visible"}animate(){if(!this.isRunning)return;let i=this.frameCount%this.cycleFrames<this.dutyFrames;this.element.nativeElement.style.visibility=i?"visible":"hidden",this.frameCount++,requestAnimationFrame(this.animationLoop)}};function K(f,e){if(f&1&&P(0,"div",null,0),f&2){let i=e.$implicit,t=A();q(H("cue conditional-visible ",i.value)),v("visible",t.showIcon()[i.class]),L("cue-key",t.fixClass(i.class))}}var o=class o extends Y{showIcon=k(Object.fromEntries(this.cues().map(e=>[e.class,!1])));fullWindowLink="/paradigms/ssvep/direction/stimuli";normalWindowLink="/paradigms/ssvep/direction";startCountdownValue=5;flickers=[];ngOnInit(){return E(this,null,function*(){T(o.prototype,this,"ngOnInit").call(this),yield this.hardwareService.writeLine("CMD=@CLA;"),yield this.hardwareService.writeLine('CMD=@TITLE "SSVEP Direction" BLUE 3;')})}generateCues(){this.cues.set([{class:"Right",value:"right"},{class:"Left",value:"left"},{class:"Up",value:"up"},{class:"Down",value:"down"}])}generateTrials(){let e=[];for(let r of this.experimentConfig.classes)for(let m=0;m<this.experimentConfig.trials_per_class;m++)e.push({class:r,duration:this.experimentConfig.stimulus_duration,soa:this.experimentConfig.soa,flicker_duration:this.experimentConfig.flicker_duration});let i=this.cuesDivElement.find(r=>r.nativeElement.getAttribute("cue-key")===this.fixClass("Up")),t=this.cuesDivElement.find(r=>r.nativeElement.getAttribute("cue-key")===this.fixClass("Down")),n=this.cuesDivElement.find(r=>r.nativeElement.getAttribute("cue-key")===this.fixClass("Right")),u=this.cuesDivElement.find(r=>r.nativeElement.getAttribute("cue-key")===this.fixClass("Left")),l=this.experimentConfig.refresh_rate;return this.flickers=[],i&&this.flickers.push(new a(i,7,l)),t&&this.flickers.push(new a(t,6,l)),n&&this.flickers.push(new a(n,5,l)),u&&this.flickers.push(new a(u,4,l)),e=this.shuffle(e),e}showTrial(e){this.propagateClassMarker(e),this.showIcon.set(Object.fromEntries(this.cues().map(i=>[i.class,i.class===e])))}setOpacity(e,i){let t=this.cuesIconElement.find(n=>n._elementRef.nativeElement.getAttribute("cue-key")===this.fixClass(e));t&&(t._elementRef.nativeElement.style.opacity=i.toString())}stopStimuliSequence(){this.showTrial(null),this.flickers.forEach(e=>e.stop())}runStimuliSequence(){let e=this.generateTrials(),i=performance.now(),t=0,n=[],u=s=>{let p=i+e.slice(0,s).reduce((h,c)=>h+c.duration+(c.flicker_duration||0)+c.soa,0);return Math.max(0,p-performance.now())},l=s=>{this.showTrial(s.class),this.onTrial(s),this.hardwareService.writeLine(`CMD=@LOG "Class: ${s.class}" GREEN;`)},r=()=>{t++,this.setProgress(100*t/e.length)},m=()=>{this.flickers.forEach(s=>s.start())},b=()=>{this.flickers.forEach(s=>s.stop())},C=()=>{n.forEach(s=>window.clearTimeout(s)),n=[],b()},w=()=>{if(t>=e.length){C(),this.onDelivery.set(!1);return}let s=e[t],p=u(t);console.log(s);let h=window.setTimeout(()=>{l(s);let c=window.setTimeout(()=>{this.showTrial(null);let $=window.setTimeout(()=>{m();let J=window.setTimeout(()=>{b(),r(),w()},s.flicker_duration||0);n.push(J)},300);n.push($)},s.duration);n.push(c)},p);n.push(h)};return w(),C}static \u0275fac=(()=>{let e;return function(t){return(e||(e=M(o)))(t||o)}})();static \u0275cmp=x({type:o,selectors:[["app-stimuli"]],features:[R],decls:4,vars:3,consts:[["cueElement",""],[3,"hostRef"],[1,"ssvep-direction-container"],[3,"class","visible"]],template:function(i,t){i&1&&(I(0,"app-stimuli-layout",1)(1,"div",2),_(2,K,2,6,"div",3,S),O()()),i&2&&(F("hostRef",t),g(),v("embedded",t.embedded==="embedded"),g(),D(t.cues()))},dependencies:[z,U,N,G,V,j,B],styles:[".ssvep-direction-container[_ngcontent-%COMP%]{position:relative;height:90%;aspect-ratio:1;margin:auto;padding:100px;box-sizing:border-box}.ssvep-direction-container.embedded[_ngcontent-%COMP%]{transform:translateY(5%)}.cue[_ngcontent-%COMP%]{background-color:var(--mat-sys-inverse-on-surface);width:15%;aspect-ratio:1;position:absolute;border-radius:10%}.cue.up[_ngcontent-%COMP%]{top:0;left:50%;transform:translate(-50%)}.cue.down[_ngcontent-%COMP%]{bottom:0;left:50%;transform:translate(-50%)}.cue.left[_ngcontent-%COMP%]{top:50%;left:0;transform:translateY(-50%)}.cue.right[_ngcontent-%COMP%]{top:50%;right:0;transform:translateY(-50%)}.cue.visible[_ngcontent-%COMP%]{border:10px solid var(--mat-sys-error);box-sizing:border-box}"]})};d([y("TRIAL",{arguments:["CLASS"],example:"Trial Right",description:"Highlights the specified class by activating its visual icon while deactivating all others. Useful for indicating the target class during a trial or cue presentation."})],o.prototype,"showTrial",1),d([y("OPACITY",{arguments:["CLASS","VALUE"],example:"OPACITY Right 0.5",description:"Sets the visual opacity of the specified class element. The value should range between 0.0 (fully transparent) and 1.0 (fully opaque)."})],o.prototype,"setOpacity",1);var W=o;export{W as a};
